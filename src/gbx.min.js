/* GBXjs 0.4.0 - (c) Petr Pivoňka & Tom - released under MIT */
!function(e){"use strict";if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e.apply(null,[].map(function(e){return require(e)}));else if("function"==typeof define&&define.amd)define([],e);else{var n;(n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).GBX=e.apply(null,[].map(function(e){return n[e]}))}}(function(){var e,n,t,r,o,u,l,m,s,h,d=[],c=[],p=new TextDecoder,b={6:"Stadium",11:"Valley",12:"Canyon",13:"Lagoon",25:"Stadium256",26:"Stadium®",10003:"Common"};function g(e){f=this.read,e.data.constructor!==Uint8Array?async function(){var n;e.data=new Uint8Array(await(n=e.data,new Promise((e,t)=>{let a=new FileReader;a.addEventListener("loadend",n=>e(n.target.result)),a.addEventListener("error",t),a.readAsArrayBuffer(n)}))),y(e,f)}():y(e,f)}function y(e,n){e.thumbnail&&(this.thumb=e.thumbnail),this.onParse=e.onParse,this.onThumb=e.onThumb,this.buffer=e.data,void 0!==this.buffer?n(this.buffer):l=1}function T(e){u=e,m=0}function v(){return r=u[m],m+=1,r}function w(e){for(o=new Uint8Array(e),i=0;i<e;i++)o[i]=v();return o}function k(){return(o=w(4))[0]|o[1]<<8|o[2]<<16|o[3]<<24}function S(){return(o=w(8))[0]|o[1]<<8|o[2]<<16|o[3]<<24|o[4]<<32|o[5]<<40|o[6]<<48|o[7]<<56}function U(e){return null==e&&(e=k()),p.decode(w(e))}function C(){return U(1)}function I(){null==s&&(s=k());var e=new Uint32Array([k()])[0];if(0==(16383&e)&&(e>>30==1||e>>30==-2)){var n=U();return c.push(n),n}if(16383!=(16383&e))return e>>30==0?null==b[e]?(l=5,e):b[e]:c.Count>(16383&e)-1?c[(16383&e)-1]:"";switch(e>>30){case 2:return"Unassigned";case 3:return"";default:l=10}}function x(){return{id:I(),collection:I(),author:I()}}function z(){return!!k()}function D(){return k().toFixed(2)}function V(){return{x:D(),y:D()}}function $(e){return btoa(new Uint8Array(e).reduce(function(e,n){return e+String.fromCharCode(n)},""))}function A(e){return void 0===e?"Trackmania 1":"Trackmania"==e||e.match(/^OrbitalDev@/g)?"Trackmania®":"TMCE@nadeolabs"==e||"TMTurbo@nadeolabs"==e?"Trackmania Turbo":"ManiaPlanet"}return g.prototype.read=function(){var i=performance.now();if(h=[],d=[],m=0,l=0,s=null,u=this.buffer,"GBX"==U(3)){if((e=(o=w(2))[0]|o[1]<<8)>=3&&(C(),C(),C(),e>=4&&C(),n=k(),e>=6&&k()>0)){for(t=k(),a=0;a<t;a++){var r=4095&k(),f=k(),c=0!=(f&1<<31);d[r]={size:2147483647&f,isHeavy:c}}for(var p in d)d[p].data=w(d[p].size),delete d[p].size;if(50606080==n||603992064==n){T(d[2].data),(g=v())<3&&(h.mapInfo=x(),h.mapName=U()),k(),g>=1&&(h.bronzeTime=k(),h.silverTime=k(),h.goldTime=k(),h.authorTime=k(),2==g&&v(),g>=4&&(h.cost=k(),g>=5&&(h.isMultilap=z(),6==g&&z(),g>=7&&(h.trackType=k(),g>=9&&(k(),g>=10&&(h.authorScore=k(),g>=11&&(h.editorMode=k(),h.isSimple=0!=(1&h.editorMode),h.hasGhostBlocks=0!=(2&h.editorMode),g>=12&&(z(),g>=13&&(h.nbCheckpoints=k(),h.nbLaps=k()))))))))),T(d[3].data);var b=v();h.mapInfo=x(),h.mapName=U(),h.mapNameD=h.mapName.replace(/\$\$/g,"$\\").replace(/\$([a-f0-9]){3}|\$([a-f0-9]){1,2}(?=[^a-f0-9])|\$([lh]\[.*?\]|[g-il-ostwz])/gi,"").replace(/\$\\/,"$"),6==v()&&(l=4),b>=1&&(h.locked=z(),h.password=U(),b>=2&&(h.decoration=x(),b>=3&&(h.mapOrigin=V(),b>=4&&(h.mapTarget=V(),b>=5&&(S(),S(),b>=6&&(h.mapType=U(),h.mapStyle=U(),b<=8&&z(),b>=8&&(h.lightmapCacheUID=$(w(8)),b>=9&&(h.lightmapVersion=v(),b>=11&&(h.titleUID=I()))))))))),h.game=A(h.titleUID),T(d[5].data),h.xml=U(),b>5&&(T(d[8].data),k(),h.authorVersion=k(),h.authorLogin=U(),h.authorNickname=U(),h.authorZone=U(),h.authorExtraInfo=U())}else if(50933760==n||604495872==n){T(d[0].data),chunk000Version=k(),chunk000Version>=2&&(h.mapInfo=x(),h.time=k(),h.driverNickname=U(),chunk000Version>=6&&(h.driverLogin=U(),chunk000Version>=8&&(v(),h.titleUID=I()))),h.game=A(h.titleUID),T(d[1].data),h.xml=U();try{T(d[2].data);var g=k();h.authorVersion=k(),h.authorLogin=U(),h.authorNickname=U(),h.authorZone=U(),h.authorExtraInfo=U()}catch(e){}}else l=3}}else l=2;if(void 0!==this.onParse&&this.onParse.length>0){var y=performance.now();this.onParse(h,l,d,y-i)}this.thumb&&(T(d[7].data),0!=k()&&(h.thumbnailSize=k(),a,U("<Thumbnail.jpg>".length),0==h.thumbnailSize?h.thumbnail=null:h.thumbnail=w(h.thumbnailSize),U("</Thumbnail.jpg>".length),U("<Comments>".length),h.comments=U(),U("</Comments>".length)),"base64"==this.thumb&&(h.thumbnail=$(h.thumbnail)));if(void 0!==this.onThumb&&this.onThumb.length>0){y=performance.now();this.onThumb(h.thumbnail,h.thumbnailSize,d,y-i)}},g});